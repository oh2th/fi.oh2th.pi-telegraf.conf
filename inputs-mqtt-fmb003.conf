# Telegraf Configuration
#

###############################################################################
# Read metrics from FMB MQTT topic(s) for GPS and telemetry data
[[inputs.mqtt_consumer]]
  client_id = "telegraf-input-mqtt-fmb"

  username = "@{telegraf_secrets:mqtt_username}"
  password = "@{telegraf_secrets:mqtt_password}"

  servers = ["tcp://localhost:1883"]
  topics = [
    "teltonika/+/+/data",
  ]

  # Don't store the topic to influx
  topic_tag = ""

  data_format = "json_v2"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "teltonika/+/+/data"
    measurement = "measurement/_/_/_"
    tags = "_/model/imei/_"

  [[inputs.mqtt_consumer.json_v2]]
    # GPS and telemetry metrics
    [[inputs.mqtt_consumer.json_v2.object]]
      path = "state.reported"
      tags = ["256", "387", "latlng"]
      timestamp_key = "ts"
      timestamp_format = "unix_ms"
      included_keys = ["12", "13", "15", "16", "17", "18", "19", "21", "24", "30", "31", "32", "36", "37", "51", "57", "66", "67", "68", "69", "80", "113", "181", "182", "199", "200", "205", "206", "239", "240", "241", "256", "303", "383", "387", "389", "410", "411", "412", "449", "543", "544", "755", "1152", "latlng", "ts", "pr", "alt", "ang", "sat", "sp", "evt"]

      [inputs.mqtt_consumer.json_v2.object.fields]
        "12" = "float"   # Fuel Used GPS (ml)
        "13" = "float"   # Fuel Rate GPS (cl/100 km)
        "15" = "float"   # Eco Score (factor 0.01)
        "16" = "float"   # Total Odometer by FMB GPS (m)
        "17" = "float"   # X-axis Acceleration (mG)
        "18" = "float"   # Y-axis Acceleration (mG)
        "19" = "float"   # Z-axis Acceleration (mG)
        "21" = "int"   # GSM Signal Strength (0-5)
        "24" = "float"   # GNSS Speed (km/h)
        "30" = "int"   # Number of DTC - Detected Error Codes
        "31" = "int"   # Engine Load (%)
        "32" = "float"   # Coolant Temperature (째C)
        "36" = "float"   # Engine RPM
        "37" = "float"   # Vehicle Speed (km/h)
        "51" = "float"   # Control Module Voltage (mV)
        "57" = "float"   # Hybrid Battery Pack Remaining Life (%)
        "66" = "float"   # External Voltage as Measured by FMB (mV)
        "67" = "float"   # FMB Internal Battery Voltage (mV)
        "68" = "float"   # FMB Internal Battery Current (mA)
        "69" = "int"   # GNSS Status (0-3)
        "80" = "int"   # Data Mode (0-5)
        "113" = "int"  # Battery Level (%)
        "181" = "float"  # GNSS PDOP (Divide by 10)
        "182" = "float"  # GNSS HDOP (Divide by 10)
        "199" = "float"  # Trip Odometer (m)
        "200" = "int"  # Sleep Mode (0-4)
        "205" = "int"  # GSM Cell ID
        "206" = "int"  # GSM Area Code
        "239" = "int"  # Ignition (0 = Off, 1 = On)
        "240" = "int"  # Movement (0 = Off, 1 = On)
        "241" = "int"  # Active GSM Operator (MNC + MNI)
        "256" = "string" # VIN (Vehicle Identification Number)
        "303" = "int"  # Instant Movement (0/1)
        "383" = "int"  # AXL Calibration Status (0-3)
        "387" = "string" # GPS Location (+Lat+Lng+Speed/)
        "389" = "float"  # Vehicle Odometer Value (km)
        "410" = "int"  # OEM Battery Charge State (0 = Not Charging, 1 = Charging)
        "411" = "int"  # OEM Battery Charge Level (%)
        "412" = "float"  # Unknown (째C)
        "449" = "float"  # Ignition On (s)
        "543" = "float"  # Hybrid System Voltage (V)
        "544" = "float"  # Hybrid System Current (A)
        "755" = "float"  # Range Remaining (km)
        "1152" = "float" # OEM Battery Temperature (째C)
        "ts" = "float"   # Timestamp
        "pr" = "float"   # Pressure (?)
        "latlng" = "string" # Latitude, Longitude
        "alt" = "int"  # Altitude (m)
        "ang" = "int"  # Angle (째)
        "sat" = "int"  # Satellites in use
        "sp" = "float"   # Speed (km/h)
        "evt" = "int"    # Event ID

###############################################################################
# Extract latitude and longitude from 'latlng'
[[processors.starlark]]
  source = '''
def apply(metric):
  # Extract the latlng tag from the metric and remove it
  latlng = metric.tags.pop("latlng", None)
  if latlng != None:
    # Split the latlng string into latitude and longitude
    coords = latlng.split(",")
    if len(coords) == 2:
      metric.fields["latitude"] = float(coords[0])
      metric.fields["longitude"] = float(coords[1])
  return metric
'''

###############################################################################
# Process metrics using a Starlark script to convert specific fields to decimals
[[processors.starlark]]
  source = '''
def apply(metric):
  fields_to_convert = {
    "12": 1000,
    "13": 100,
    "15": 100,
    "32": 10,
    "66": 1000,
    "67": 1000,
    "68": 1000,
    "181": 10,
    "182": 10
  }

  for field in fields_to_convert:
    divisor = fields_to_convert[field]
    value = metric.fields.get(field)
    if value != None and type(value) in ("int", "float"):
      metric.fields[field] = value / divisor

  return metric
'''

###############################################################################
# Rename numeric field names to meaningful names
[[processors.rename]]
  [[processors.rename.replace]]
    field = "12"
    dest = "gps_fuel_used"
  [[processors.rename.replace]]
    field = "13"
    dest = "gps_fuel_rate"
  [[processors.rename.replace]]
    field = "15"
    dest = "eco_score"
  [[processors.rename.replace]]
    field = "16"
    dest = "gps_total_odometer"
  [[processors.rename.replace]]
    field = "17"
    dest = "acceleration_x"
  [[processors.rename.replace]]
    field = "18"
    dest = "acceleration_y"
  [[processors.rename.replace]]
    field = "19"
    dest = "acceleration_z"
  [[processors.rename.replace]]
    field = "21"
    dest = "gsm_signal_strength"
  [[processors.rename.replace]]
    field = "24"
    dest = "gnss_speed_kmh"
  [[processors.rename.replace]]
    field = "30"
    dest = "dtc_error_count"
  [[processors.rename.replace]]
    field = "31"
    dest = "engine_load_pct"
  [[processors.rename.replace]]
    field = "32"
    dest = "coolant_temp_c"
  [[processors.rename.replace]]
    field = "36"
    dest = "engine_rpm"
  [[processors.rename.replace]]
    field = "37"
    dest = "vehicle_speed_kmh"
  [[processors.rename.replace]]
    field = "51"
    dest = "control_module_voltage"
  [[processors.rename.replace]]
    field = "57"
    dest = "hybrid_battery_remaining_life_pct"
  [[processors.rename.replace]]
    field = "66"
    dest = "fmb_external_voltage"
  [[processors.rename.replace]]
    field = "67"
    dest = "fmb_internal_battery_voltage"
  [[processors.rename.replace]]
    field = "68"
    dest = "fmb_internal_battery_current"
  [[processors.rename.replace]]
    field = "69"
    dest = "gnss_status"
  [[processors.rename.replace]]
    field = "80"
    dest = "data_mode"
  [[processors.rename.replace]]
    field = "113"
    dest = "battery_level_pct"
  [[processors.rename.replace]]
    field = "181"
    dest = "gnss_pdop"
  [[processors.rename.replace]]
    field = "182"
    dest = "gnss_hdop"
  [[processors.rename.replace]]
    field = "199"
    dest = "trip_odometer_m"
  [[processors.rename.replace]]
    field = "200"
    dest = "sleep_mode"
  [[processors.rename.replace]]
    field = "205"
    dest = "gsm_cell_id"
  [[processors.rename.replace]]
    field = "206"
    dest = "gsm_area_code"
  [[processors.rename.replace]]
    field = "239"
    dest = "ignition"
  [[processors.rename.replace]]
    field = "240"
    dest = "movement"
  [[processors.rename.replace]]
    field = "241"
    dest = "active_gsm_operator"
  [[processors.rename.replace]]
    tag = "256"
    dest = "vin"
  [[processors.rename.replace]]
    field = "303"
    dest = "instant_movement"
  [[processors.rename.replace]]
    field = "383"
    dest = "acceleration_calibration_status"
  [[processors.rename.replace]]
    tag = "387"
    dest = "gps_location"
  [[processors.rename.replace]]
    field = "389"
    dest = "vehicle_odometer_km"
  [[processors.rename.replace]]
    field = "410"
    dest = "oem_battery_charge_state"
  [[processors.rename.replace]]
    field = "411"
    dest = "oem_battery_charge_level_pct"
  [[processors.rename.replace]]
    field = "412"
    dest = "unknown_temp"
  [[processors.rename.replace]]
    field = "449"
    dest = "ignition_on_s"
  [[processors.rename.replace]]
    field = "543"
    dest = "hybrid_system_voltage"
  [[processors.rename.replace]]
    field = "544"
    dest = "hybrid_system_current"
  [[processors.rename.replace]]
    field = "755"
    dest = "range_remaining_lm"
  [[processors.rename.replace]]
    field = "1152"
    dest = "oem_battery_temperature_c"
  [[processors.rename.replace]]
    field = "alt"
    dest = "altitude"
  [[processors.rename.replace]]
    field = "ang"
    dest = "angle"
  [[processors.rename.replace]]
    field = "sat"
    dest = "satellites"
  [[processors.rename.replace]]
    field = "sp"
    dest = "speed"
  [[processors.rename.replace]]
    field = "evt"
    dest = "event_id"
